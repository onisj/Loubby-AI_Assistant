<!DOCTYPE html>
<html>
<head>
    <title>Loubby AI Voice/Video Chat</title>
    <style>
        #avatar-container { 
            width: 200px; 
            height: 200px; 
            margin: 0 auto; 
        }
        #video-player { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        #status { 
            font-size: 18px; 
            text-align: center; 
        }
    </style>
</head>
<body>
    <h1>Loubby AI Voice/Video Chat</h1>
    <div id="avatar-container">
        <video id="video-player" loop muted></video>
    </div>
    <audio id="audioOutput" autoplay></audio>
    <p id="status">Connecting...</p>
    <script>
        const ws = new WebSocket('ws://localhost:8001/ws');
        const audioOutput = document.getElementById('audioOutput');
        const status = document.getElementById('status');
        const videoPlayer = document.getElementById('video-player');
        let pc;

        ws.onopen = () => {
            status.textContent = "Connected! Starting audio...";
            startAudio();
        };

        ws.onmessage = async (event) => {
            const data = JSON.parse(event.data);
            if (data.sdp) {
                await pc.setRemoteDescription(new RTCSessionDescription(data));
            } else if (data.ice) {
                await pc.addIceCandidate(new RTCIceCandidate(data.ice));
            }
        };

        async function startAudio() {
            pc = new RTCPeerConnection();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            stream.getTracks().forEach(track => pc.addTrack(track, stream));

            pc.ontrack = (event) => {
                audioOutput.srcObject = event.streams[0];
                status.textContent = "AI is speaking...";
                videoPlayer.src = '/static/avatar_clip.mp4';
                videoPlayer.play();
                audioOutput.onplay = () => videoPlayer.currentTime = 0; // Sync video start
                audioOutput.onended = () => {
                    videoPlayer.pause();
                    videoPlayer.currentTime = 0;
                    status.textContent = "Connected! Starting audio...";
                };
            };

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({ ice: event.candidate }));
                }
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            ws.send(JSON.stringify({ sdp: offer.sdp, type: offer.type }));

            fetch('http://localhost:8001/offer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sdp: offer.sdp, type: offer.type })
            }).then(res => res.json()).then(data => {
                pc.setRemoteDescription(new RTCSessionDescription(data));
            });
        }

        ws.onerror = (error) => status.textContent = "Error: " + error.message;
        ws.onclose = () => status.textContent = "Disconnected.";
    </script>
</body>
</html>